{"version":3,"sources":["../../../src/utils/schema/assign-links-to-one.js"],"names":["schema","record","exec","properties","propertiesNames","__propertiesNames","promises","propertyName","property","hasMany","type","array","name","link","push","__assignLink","length","Promise","resolve","all","then","pin","lastIndexOf","slice","criteria","value","pick","undefined","Array","isArray","id","in","Object","assign"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;;;kBAEgBA,MAAD,IAAY,CAACC,MAAD,EAASC,IAAT,KAAkB;AAC3C,QAAMC,aAAaH,OAAOG,UAA1B;AACA,QAAMC,kBAAkBJ,OAAOK,iBAA/B;AACA,QAAMC,WAAW,EAAjB;;AAEA,OAAK,IAAIC,YAAT,IAAyBH,eAAzB,EAA0C;AACxC,QAAII,WAAWL,WAAYI,YAAZ,CAAf;AACA,QAAIE,UAAUD,SAASE,IAAT,KAAkB,sBAAYC,KAA5C;AACA,QAAIC,OAAOH,UAAU,MAAV,GAAmB,KAA9B;;AAEA,QAAI,CAAC,CAACD,SAASK,IAAX,IAAmBD,QAAQJ,SAASK,IAAxC,EAA8C;AAC5CP,eAASQ,IAAT,CAAcC,aAAaR,YAAb,EAA2BE,OAA3B,EAAoCD,SAASK,IAAT,CAAeD,IAAf,CAApC,CAAd;AACD;AACF;;AAED,MAAI,CAACN,SAASU,MAAd,EAAsB;AACpB,WAAOC,QAAQC,OAAR,CAAgBjB,MAAhB,CAAP;AACD;;AAED;AACA,SAAOgB,QAAQE,GAAR,CAAYb,QAAZ,EAAsBc,IAAtB,CAA2B,MAAMnB,MAAjC,CAAP;;AAEA,WAASc,YAAT,CAAsBR,YAAtB,EAAoCE,OAApC,EAA6CY,GAA7C,EAAkD;AAChD,UAAMT,OAAO,CAAC,CAAC,CAACL,aAAae,WAAb,CAAyB,GAAzB,CAAH,GACTf,aAAagB,KAAb,CAAmB,CAAnB,EAAsBhB,aAAae,WAAb,CAAyB,GAAzB,CAAtB,CADS,GAETf,YAFJ;AAGA,UAAMiB,WAAW,EAAjB;AACA,UAAMC,QAAQ,oBAAIC,IAAJ,CAASnB,YAAT,EAAuBN,MAAvB,CAAd;;AAEA,QAAIwB,UAAUE,SAAV,IAAwBlB,WAAWmB,MAAMC,OAAN,CAAcJ,KAAd,CAAX,IAAmC,CAACA,MAAMT,MAAtE,EAA+E;AAC7E,aAAOC,QAAQC,OAAR,CAAgBjB,MAAhB,CAAP;AACD;;AAED,QAAIQ,OAAJ,EAAa;AACXe,eAASM,EAAT,GAAc,EAAEC,IAAIN,KAAN,EAAd;AACD,KAFD,MAEO;AACLD,eAASM,EAAT,GAAcL,KAAd;AACD;;AAED,WAAOvB,kBAAUmB,GAAV,IAAeG,QAAf,KACJJ,IADI,CACCP,QAAQ;AACZ,UAAIJ,OAAJ,EAAa;AACXR,eAAQW,IAAR,IAAiBC,IAAjB;AACD,OAFD,MAEO;AACLmB,eAAOC,MAAP,CAAc,oBAAIP,IAAJ,CAASd,IAAT,EAAeX,MAAf,CAAd,EAAsCY,IAAtC;AACD;;AAED,aAAOZ,MAAP;AACD,KATI,CAAP;AAUD;AACF,C","file":"assign-links-to-one.js","sourcesContent":["import dot from 'dot-object';\nimport SchemaTypes from './../schema-types';\n\nexport default (schema) => (record, exec) => {\n  const properties = schema.properties;\n  const propertiesNames = schema.__propertiesNames;\n  const promises = [];\n  \n  for (let propertyName of propertiesNames) {\n    let property = properties[ propertyName ];\n    let hasMany = property.type === SchemaTypes.array;\n    let name = hasMany ? 'list' : 'one';\n    \n    if (!!property.link && name in property.link) {\n      promises.push(__assignLink(propertyName, hasMany, property.link[ name ]));\n    }\n  }\n  \n  if (!promises.length) {\n    return Promise.resolve(record);\n  }\n  \n  // Получаем все связанные объекты и сетим их себе\n  return Promise.all(promises).then(() => record);\n  \n  function __assignLink(propertyName, hasMany, pin) {\n    const name = !!~propertyName.lastIndexOf('.')\n      ? propertyName.slice(0, propertyName.lastIndexOf('.'))\n      : propertyName;\n    const criteria = {};\n    const value = dot.pick(propertyName, record);\n    \n    if (value === undefined || (hasMany && Array.isArray(value) && !value.length)) {\n      return Promise.resolve(record);\n    }\n    \n    if (hasMany) {\n      criteria.id = { in: value };\n    } else {\n      criteria.id = value;\n    }\n    \n    return exec({ ...pin, criteria })\n      .then(link => {\n        if (hasMany) {\n          record[ name ] = link;\n        } else {\n          Object.assign(dot.pick(name, record), link);\n        }\n        \n        return record;\n      });\n  }\n};"]}