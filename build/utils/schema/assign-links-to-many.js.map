{"version":3,"sources":["../../../src/utils/schema/assign-links-to-many.js"],"names":["schema","records","exec","properties","links","__assignLinksMany","keys","length","resolve","criteria","reduce","result","record","propertyName","property","hasMany","type","array","value","pick","undefined","Array","isArray","data","list","map","has","push","set","get","all","name","lastIndexOf","slice","pin","loadOne","id","in","then","recordsLinks","link","innerList","forEach","i"],"mappings":"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","file":"assign-links-to-many.js","sourcesContent":["import dot from 'dot-object';\nimport SchemaTypes from './../schema-types';\n\nexport default (schema) => (records, exec) => {\n  const properties = schema.properties;\n  const links = schema.__assignLinksMany;\n  \n  if (!links.keys.length) {\n    return Promise.resolve(records);\n  }\n  \n  const criteria = records.reduce((result, record) => {\n    \n    for(let propertyName of links.keys) {\n      let property = properties[ propertyName ];\n      let hasMany = property.type === SchemaTypes.array;\n      let value = dot.pick(propertyName, record);\n      \n      if (value === undefined || value === null || (hasMany && Array.isArray(value) && !value.length)) {\n        continue;\n      }\n      \n      let data = result[ propertyName ] = result[ propertyName ] || {\n          list: [],\n          map : hasMany ? new WeakMap() : new Map(),\n        };\n      \n      if (!data.map.has(value)) {\n        data.list.push(value);\n        data.map.set(value, []);\n      }\n      \n      data.map.get(value).push(record);\n    }\n    \n    return result;\n  }, {});\n  \n  // Получаем все связанные объекты и сетим их себе\n  return Promise\n    .all(Object.keys(criteria).map(propertyName => {\n      let name = !!~propertyName.lastIndexOf('.')\n        ? propertyName.slice(0, propertyName.lastIndexOf('.'))\n        : propertyName;\n      let hasMany = properties[ propertyName ].type === SchemaTypes.array;\n      let list = criteria[ propertyName ].list;\n      let map = criteria[ propertyName ].map;\n      \n      if (!list.length) {\n        return Promise.resolve();\n      }\n      \n      const pin = links[ propertyName ];\n      \n      return hasMany ? Promise.all(list.map(loadOne)) : loadOne(list);\n      \n      function loadOne(list) {\n        return exec({ ...pin, criteria: { id: { in: list } } })\n          .then(recordsLinks => recordsLinks.map(link => map.get(hasMany ? list : link.id).map(record => {\n            if (hasMany) {\n              let innerList = dot.pick(name, record);\n              innerList.forEach((id, i) => {\n                if (link.id === id) {\n                  innerList[ i ] = link;\n                }\n              });\n            }\n            else {\n              Object.assign(dot.pick(name, record), link);\n            }\n      \n            return record;\n          })));\n      }\n    }))\n    .then(() => records);\n};"]}