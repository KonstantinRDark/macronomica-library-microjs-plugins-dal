{"version":3,"sources":["../../../src/utils/schema/index.js"],"names":["PropertyMustBeType","message","type","code","propertyName","propertyType","DetectedSqlInjectionError","propertyValue","ValidateError","Types","FIELDS_MASK","Schema","constructor","modelName","properties","tableName","fieldsMask","undefined","Array","isArray","some","name","schema","getTableName","replace","dbProperties","id","number","dbName","autoincrement","Object","keys","reduce","nameToDbName","assign","__propertiesNames","__masks","getFieldsMask","__assignLinksMany","result","property","link","push","getMyFields","fields","has","setParams","params","names","value","pick","convertIn","valid","validate","error","getMyCriteriaParams","props","null","migrateCreateTableSchema","options","primaryKey","autoIncrement","notNull","unique","assignLinksToOne","assignLinksToMany","indexOf","match","slice","toUpperCase","propertyMasks","fieldMask","list","split","hasNot","full","toLocaleLowerCase"],"mappings":"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","file":"index.js","sourcesContent":["import Joi from 'joi';\nimport WrappedError from 'error/wrapped';\nimport TypedError from 'error/typed';\nimport dot from 'dot-object';\nimport isString from 'lodash.isstring';\nimport isPlainObject from 'lodash.isplainobject';\nimport isBoolean from 'lodash.isboolean';\nimport uniq from 'lodash.uniq';\n\nimport SchemaTypes from './../schema-types';\nimport assignLinksToOne from './assign-links-to-one';\nimport assignLinksToMany from './assign-links-to-many';\nimport sqlStringProtector from './../sql-string-protector';\n\nconst PropertyMustBeType = TypedError({\n  message     : '{name} - свойство \"{propertyName}\" должно быть \"{propertyType}\"',\n  type        : 'micro.plugins.dal.schema.property.must.be.type',\n  code        : 400,\n  propertyName: null,\n  propertyType: null\n});\n\nconst DetectedSqlInjectionError = TypedError({\n  message      : '{name} - обнаружена потенциальная SQL инъекция в свойстве \"{propertyName}\"',\n  type         : 'micro.plugins.dal.schema.detected.sql.injection',\n  code         : 500,\n  propertyName : null,\n  propertyValue: null\n});\n\nconst ValidateError = WrappedError({\n  message      : '{name} - ошибка валидации свойства {propertyName} - {origMessage}',\n  type         : 'micro.plugins.dal.schema.validate.error',\n  code         : 400,\n  propertyName : null,\n  propertyValue: null\n});\n\nexport const Types = SchemaTypes;\nexport const FIELDS_MASK = [ 'full' ];\n\nexport default class Schema {\n  tableName = undefined;\n  \n  constructor(modelName, properties = { }, { tableName, fieldsMask } = { }) {\n    if (!isString(modelName)) {\n      throw PropertyMustBeType({ propertyName: 'modelName', propertyType: 'string' });\n    }\n    \n    if (fieldsMask !== undefined\n      && (!Array.isArray(fieldsMask) || fieldsMask.some(name => !isString(name)))\n    ) {\n      throw PropertyMustBeType({ propertyName: 'fieldsMask', propertyType: 'array<string>' });\n    }\n    \n    if (!isString(tableName)) {\n      throw PropertyMustBeType({ propertyName: 'tableName', propertyType: 'string' });\n    }\n  \n    let schema = this;\n    schema.fieldsMask = uniq([ ...FIELDS_MASK, ...(fieldsMask || []) ]);\n    schema.tableName = (tableName || getTableName(modelName)).replace(/-/g, '_');\n    schema.dbProperties = {};\n    \n    schema.properties = {\n      id: {\n        type         : SchemaTypes.number,\n        name         : 'id',\n        dbName       : 'id',\n        autoincrement: true\n      },\n      ...(Object\n        .keys(properties)\n        .reduce((properties, name) => {\n          let dbName = nameToDbName(name);\n          this.dbProperties[ dbName ] = Object.assign(properties[ name ], { name, dbName });\n          return properties;\n        }, properties))\n    };\n    schema.dbProperties.id = schema.properties.id;\n    schema.__propertiesNames = Object.keys(schema.properties);\n    schema.__masks = getFieldsMask(schema.__propertiesNames, schema.properties, schema.fieldsMask);\n    \n    schema.__assignLinksMany = schema.__propertiesNames.reduce((result, propertyName) => {\n      let property = schema.properties[ propertyName ];\n      let name = 'list';\n  \n      if ('link' in property && name in property.link) {\n        result.keys.push(propertyName);\n        result[ propertyName ] = property.link[ name ];\n      }\n  \n      return result;\n    }, { keys: [] });\n  }\n  \n  getMyFields = (fields) => {\n    // Если в свойстве fields строка - берем заранее заготовленный список пло маске\n    if (isString(fields)) {\n      if (!!this.__masks[ fields ]) {\n        return this.__masks[ fields ];\n      }\n      \n      fields = undefined;\n    }\n    \n    if (fields === undefined) {\n      fields = [ 'id' ];\n    }\n    \n    if (Array.isArray(fields)) {\n      return fields.reduce((fields, name) => {\n        if (this.has(name)) {\n          fields.push(name);\n        }\n        return fields;\n      }, []);\n    }\n  };\n  \n  setParams = (params) => {\n    let schema = this;\n    let names = Object.keys(schema.properties);\n    let result = {};\n    \n    for(let propertyName of names) {\n      let property = schema.properties[ propertyName ];\n      let value = dot.pick(propertyName, params) || dot.pick(property.dbName, params);\n      \n      if (value === undefined) {\n        continue;\n      }\n      \n      if (!sqlStringProtector(value)) {\n        throw DetectedSqlInjectionError({ propertyName, propertyValue: value });\n      }\n      \n      if ('convertIn' in property.type) {\n        value = property.type.convertIn(value, property);\n      }\n      \n      let valid = schema.validate(propertyName, value);\n      \n      if (valid.error) {\n        throw valid.error;\n      }\n      \n      result[ property.dbName ] = valid.value;\n    }\n    \n    return result;\n  };\n  \n  getMyCriteriaParams = (params = {}) => {\n    let schema = this;\n    let result = Object.keys(schema.properties).reduce(reduce, {});\n    return result;\n    \n    function reduce(result, propertyName) {\n      let property = schema.properties[ propertyName ];\n      let value = dot.pick(propertyName, params) || dot.pick(property.dbName, params);\n      \n      if (value !== undefined) {\n        result[ property.dbName ] = value;\n      }\n      \n      return result;\n    }\n  };\n  \n  has = (property) => {\n    return isString(property) && !!this.properties[ property ];\n  };\n  \n  validate = (propertyName, value) => {\n    const props = this.properties[ propertyName ];\n    if (!props) { return false }\n    \n    if ('null' in props && props.null === true && (value === null || value === '')) {\n      return {\n        value,\n        error: undefined\n      };\n    }\n    \n    const valid = Joi.validate(value, props.type.schema(props));\n    \n    if (valid.error) {\n      valid.error = ValidateError(valid.error, { propertyName, propertyValue: value });\n    }\n    \n    return valid;\n  };\n  \n  migrateCreateTableSchema = () => {\n    const fields = Object.keys(this.properties);\n    const result = {};\n    \n    for(let name of fields) {\n      let options = this.properties[ name ];\n      \n      if (name === 'id') {\n        result[ name ] = { type: 'int', primaryKey: true, autoIncrement: true, notNull: true };\n        continue;\n      }\n      \n      let type;\n      \n      switch (options.type.value) {\n        case 'date' : { type = 'date'; break }\n        case 'text' : { type = 'text'; break }\n        case 'float' : { type = 'decimal'; break }\n        case 'money' : { type = 'decimal'; break }\n        case 'number' :\n        case 'integer': { type = 'int'; break }\n        case 'string' : { type = 'string'; break }\n        case 'boolean': { type = 'boolean'; break }\n        case 'smallint': { type = 'smallint'; break }\n        case 'datetime': { type = 'datetime'; break }\n        case 'array': { type = 'string'; break }\n      }\n      \n      if (!type) { continue }\n      \n      let params = { type };\n      \n      params.notNull = !(options.null === true);\n      \n      if ('unique' in options) {\n        params.unique = options.unique === true;\n      }\n      \n      result[ options.dbName ] = params;\n    }\n    \n    return result;\n  };\n  \n  assignLinksToOne = assignLinksToOne(this);\n  \n  assignLinksToMany = assignLinksToMany(this);\n}\n\nfunction nameToDbName(name) {\n  if (!~name.indexOf('.')) {\n    return name;\n  }\n  \n  return name.replace(/\\.\\w{1}/gi, match => match.slice(1).toUpperCase());\n}\n\nfunction getFieldsMask(names, properties, fieldsMask) {\n  return names.reduce((result, propertyName) => {\n    const property = properties[ propertyName ];\n    \n    let propertyMasks = property.fieldsMask;\n    \n    if (propertyMasks === undefined) {\n      propertyMasks = true;\n    }\n    \n    if (isBoolean(propertyMasks)) {\n      propertyMasks = fieldsMask.reduce((result, fieldMask) => {\n        result[ fieldMask ] = propertyMasks;\n        return result;\n      }, {});\n    }\n    \n    // Если указали в формате строки - разобьем ее по сепаратору и преобразуем к объекту\n    // Если указали в формате массива - преобразуем к объекту\n    if (isString(propertyMasks) || Array.isArray(propertyMasks)) {\n      let list = isString(propertyMasks) ? propertyMasks.split(':') : propertyMasks;\n      propertyMasks = list.reduce((result, name) => {\n        let hasNot = !!~name.indexOf('!');\n        \n        if (!~name.indexOf('!')) {\n          result[ name ] = true;\n        }\n        \n        return result;\n      }, {});\n    }\n    \n    if (!isPlainObject(propertyMasks)) {\n      throw PropertyMustBeType({\n        propertyName: `${ propertyName }.fieldsMask`,\n        propertyType: 'string | array<string> | object'\n      });\n    }\n    \n    return fieldsMask.reduce((result, fieldMask) => {\n      result[ fieldMask ] = result[ fieldMask ] || [];\n      \n      // Если в описании свойства указали fieldsMask\n      // И указанное значение равно true - добавим его во все маски\n      if (\n        fieldMask === 'full' && (!(fieldMask in propertyMasks) || propertyMasks[ fieldMask ] !== false)\n        || fieldMask in propertyMasks && propertyMasks[ fieldMask ] === true\n      ) {\n        result[ fieldMask ].push(property.dbName);\n      }\n      \n      return result;\n    }, result);\n  }, { full: [] });\n}\n\n/**\n * @param {string} name\n * @returns {string}\n */\nfunction getTableName(name) {\n  return name.toLocaleLowerCase();\n}"]}