{"version":3,"sources":["../../src/utils/schema.js"],"names":["PropertyMustBeType","message","type","code","propertyName","propertyType","DetectedSqlInjectionError","propertyValue","ValidateError","Types","FIELDS_MASK","Schema","constructor","modelName","properties","tableName","fieldsMask","undefined","Array","isArray","some","name","getTableName","replace","dbProperties","id","number","dbName","autoincrement","Object","keys","reduce","nameToDbName","assign","__propertiesNames","__masks","getFieldsMask","getMyFields","fields","has","push","setParams","params","schema","names","result","property","value","pick","convertIn","valid","validate","error","getMyCriteriaParams","props","null","migrateCreateTableSchema","options","primaryKey","autoIncrement","notNull","unique","assignLinksToOne","record","exec","propertiesNames","promises","hasMany","array","link","__assignLink","length","Promise","resolve","all","then","pin","slice","lastIndexOf","criteria","in","assignLinksToMany","records","indexOf","match","toUpperCase","propertyMasks","fieldMask","list","split","hasNot","full","toLocaleLowerCase"],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,MAAMA,qBAAqB,qBAAW;AACpCC,WAAc,iEADsB;AAEpCC,QAAc,gDAFsB;AAGpCC,QAAc,GAHsB;AAIpCC,gBAAc,IAJsB;AAKpCC,gBAAc;AALsB,CAAX,CAA3B;;AAQA,MAAMC,4BAA4B,qBAAW;AAC3CL,WAAe,4EAD4B;AAE3CC,QAAe,iDAF4B;AAG3CC,QAAe,GAH4B;AAI3CC,gBAAe,IAJ4B;AAK3CG,iBAAe;AAL4B,CAAX,CAAlC;;AAQA,MAAMC,gBAAgB,uBAAa;AACjCP,WAAe,mEADkB;AAEjCC,QAAe,yCAFkB;AAGjCC,QAAe,GAHkB;AAIjCC,gBAAe,IAJkB;AAKjCG,iBAAe;AALkB,CAAb,CAAtB;;AAQO,MAAME,6CAAN;AACA,MAAMC,oCAAc,CAAE,MAAF,CAApB;;AAEQ,MAAMC,MAAN,CAAa;;AAG1BC,cAAYC,SAAZ,EAA0E;AAAA,QAAnDC,UAAmD,uEAAtC,EAAsC;;AAAA,mFAAL,EAAK;;AAAA,QAA/BC,SAA+B,QAA/BA,SAA+B;AAAA,QAApBC,UAAoB,QAApBA,UAAoB;;AAAA;;AACxE,QAAI,CAAC,sBAASH,SAAT,CAAL,EAA0B;AACxB,YAAMb,mBAAmB,EAAEI,cAAc,WAAhB,EAA6BC,cAAc,QAA3C,EAAnB,CAAN;AACD;;AAED,QAAIW,eAAeC,SAAf,KACE,CAACC,MAAMC,OAAN,CAAcH,UAAd,CAAD,IAA8BA,WAAWI,IAAX,CAAgBC,QAAQ,CAAC,sBAASA,IAAT,CAAzB,CADhC,CAAJ,EAEE;AACA,YAAMrB,mBAAmB,EAAEI,cAAc,YAAhB,EAA8BC,cAAc,eAA5C,EAAnB,CAAN;AACD;;AAED,QAAI,CAAC,sBAASU,SAAT,CAAL,EAA0B;AACxB,YAAMf,mBAAmB,EAAEI,cAAc,WAAhB,EAA6BC,cAAc,QAA3C,EAAnB,CAAN;AACD;;AAED,SAAKW,UAAL,GAAkB,sBAAK,CAAE,GAAGN,WAAL,EAAkB,IAAIM,cAAc,EAAlB,CAAlB,CAAL,CAAlB;AACA,SAAKD,SAAL,GAAiB,CAACA,aAAaO,aAAaT,SAAb,CAAd,EAAuCU,OAAvC,CAA+C,IAA/C,EAAqD,GAArD,CAAjB;AACA,SAAKC,YAAL,GAAoB,EAApB;;AAEA,SAAKV,UAAL;AACEW,UAAI;AACFvB,cAAe,sBAAYwB,MADzB;AAEFL,cAAe,IAFb;AAGFM,gBAAe,IAHb;AAIFC,uBAAe;AAJb;AADN,OAOMC,OACDC,IADC,CACIhB,UADJ,EAEDiB,MAFC,CAEM,CAACjB,UAAD,EAAaO,IAAb,KAAsB;AAC5B,UAAIM,SAASK,aAAaX,IAAb,CAAb;AACA,WAAKG,YAAL,CAAmBG,MAAnB,IAA8BE,OAAOI,MAAP,CAAcnB,WAAYO,IAAZ,CAAd,EAAkC,EAAEA,IAAF,EAAQM,MAAR,EAAlC,CAA9B;AACA,aAAOb,UAAP;AACD,KANC,EAMCA,UAND,CAPN;AAeA,SAAKU,YAAL,CAAkBC,EAAlB,GAAuB,KAAKX,UAAL,CAAgBW,EAAvC;AACA,SAAKS,iBAAL,GAAyBL,OAAOC,IAAP,CAAY,KAAKhB,UAAjB,CAAzB;AACA,SAAKqB,OAAL,GAAeC,cAAc,KAAKF,iBAAnB,EAAsC,KAAKpB,UAA3C,EAAuD,KAAKE,UAA5D,CAAf;AACD;;AAxCyB;;kBAAPL,M;;;;;OACnBI,S,GAAYE,S;;OAyCZoB,W,GAAeC,MAAD,IAAY;AACxB;AACA,QAAI,sBAASA,MAAT,CAAJ,EAAsB;AACpB,UAAI,CAAC,CAAC,KAAKH,OAAL,CAAcG,MAAd,CAAN,EAA8B;AAC5B,eAAO,KAAKH,OAAL,CAAcG,MAAd,CAAP;AACD;;AAEDA,eAASrB,SAAT;AACD;;AAED,QAAIqB,WAAWrB,SAAf,EAA0B;AACxBqB,eAAS,CAAE,IAAF,CAAT;AACD;;AAED,QAAIpB,MAAMC,OAAN,CAAcmB,MAAd,CAAJ,EAA2B;AACzB,aAAOA,OAAOP,MAAP,CAAc,CAACO,MAAD,EAASjB,IAAT,KAAkB;AACrC,YAAI,KAAKkB,GAAL,CAASlB,IAAT,CAAJ,EAAoB;AAClBiB,iBAAOE,IAAP,CAAYnB,IAAZ;AACD;AACD,eAAOiB,MAAP;AACD,OALM,EAKJ,EALI,CAAP;AAMD;AACF,G;;OAEDG,S,GAAaC,MAAD,IAAY;AACtB,QAAIC,SAAS,IAAb;AACA,QAAIC,QAAQf,OAAOC,IAAP,CAAYa,OAAO7B,UAAnB,CAAZ;AACA,QAAI+B,SAAS,EAAb;;AAEA,SAAI,IAAIzC,YAAR,IAAwBwC,KAAxB,EAA+B;AAC7B,UAAIE,WAAWH,OAAO7B,UAAP,CAAmBV,YAAnB,CAAf;AACA,UAAI2C,QAAQ,oBAAIC,IAAJ,CAAS5C,YAAT,EAAuBsC,MAAvB,KAAkC,oBAAIM,IAAJ,CAASF,SAASnB,MAAlB,EAA0Be,MAA1B,CAA9C;;AAEA,UAAIK,UAAU9B,SAAd,EAAyB;AACvB;AACD;;AAED,UAAI,CAAC,kCAAmB8B,KAAnB,CAAL,EAAgC;AAC9B,cAAMzC,0BAA0B,EAAEF,YAAF,EAAgBG,eAAewC,KAA/B,EAA1B,CAAN;AACD;;AAED,UAAI,eAAeD,SAAS5C,IAA5B,EAAkC;AAChC6C,gBAAQD,SAAS5C,IAAT,CAAc+C,SAAd,CAAwBF,KAAxB,CAAR;AACD;;AAED,UAAIG,QAAQP,OAAOQ,QAAP,CAAgB/C,YAAhB,EAA8B2C,KAA9B,CAAZ;;AAEA,UAAIG,MAAME,KAAV,EAAiB;AACf,cAAMF,MAAME,KAAZ;AACD;;AAEDP,aAAQC,SAASnB,MAAjB,IAA4BuB,MAAMH,KAAlC;AACD;;AAED,WAAOF,MAAP;AACD,G;;OAEDQ,mB,GAAsB,YAAiB;AAAA,QAAhBX,MAAgB,uEAAP,EAAO;;AACrC,QAAIC,cAAJ;AACA,QAAIE,SAAShB,OAAOC,IAAP,CAAYa,OAAO7B,UAAnB,EAA+BiB,MAA/B,CAAsCA,MAAtC,EAA8C,EAA9C,CAAb;AACA,WAAOc,MAAP;;AAEA,aAASd,MAAT,CAAgBc,MAAhB,EAAwBzC,YAAxB,EAAsC;AACpC,UAAI0C,WAAWH,OAAO7B,UAAP,CAAmBV,YAAnB,CAAf;AACA,UAAI2C,QAAQ,oBAAIC,IAAJ,CAAS5C,YAAT,EAAuBsC,MAAvB,KAAkC,oBAAIM,IAAJ,CAASF,SAASnB,MAAlB,EAA0Be,MAA1B,CAA9C;;AAEA,UAAIK,UAAU9B,SAAd,EAAyB;AACvB4B,eAAQC,SAASnB,MAAjB,IAA4BoB,KAA5B;AACD;;AAED,aAAOF,MAAP;AACD;AACF,G;;OAEDN,G,GAAOO,QAAD,IAAc;AAClB,WAAO,sBAASA,QAAT,KAAsB,CAAC,CAAC,KAAKhC,UAAL,CAAiBgC,QAAjB,CAA/B;AACD,G;;OAEDK,Q,GAAW,CAAC/C,YAAD,EAAe2C,KAAf,KAAyB;AAClC,UAAMO,QAAQ,KAAKxC,UAAL,CAAiBV,YAAjB,CAAd;AACA,QAAI,CAACkD,KAAL,EAAY;AAAE,aAAO,KAAP;AAAc;;AAE5B,QAAI,UAAUA,KAAV,IAAmBA,MAAMC,IAAN,KAAe,IAAlC,KAA2CR,UAAU,IAAV,IAAkBA,UAAU,EAAvE,CAAJ,EAAgF;AAC9E,aAAO;AACLA,aADK;AAELK,eAAOnC;AAFF,OAAP;AAID;;AAED,UAAMiC,QAAQ,cAAIC,QAAJ,CAAaJ,KAAb,EAAoBO,MAAMpD,IAAN,CAAWyC,MAAX,CAAkBW,KAAlB,CAApB,CAAd;;AAEA,QAAIJ,MAAME,KAAV,EAAiB;AACfF,YAAME,KAAN,GAAc5C,cAAc0C,MAAME,KAApB,EAA2B,EAAEhD,YAAF,EAAgBG,eAAewC,KAA/B,EAA3B,CAAd;AACD;;AAED,WAAOG,KAAP;AACD,G;;OAEDM,wB,GAA2B,MAAM;AAC/B,UAAMlB,SAAST,OAAOC,IAAP,CAAY,KAAKhB,UAAjB,CAAf;AACA,UAAM+B,SAAS,EAAf;;AAEA,SAAI,IAAIxB,IAAR,IAAgBiB,MAAhB,EAAwB;AACtB,UAAImB,UAAU,KAAK3C,UAAL,CAAiBO,IAAjB,CAAd;;AAEA,UAAIA,SAAS,IAAb,EAAmB;AACjBwB,eAAQxB,IAAR,IAAiB,EAAEnB,MAAM,KAAR,EAAewD,YAAY,IAA3B,EAAiCC,eAAe,IAAhD,EAAsDC,SAAS,IAA/D,EAAjB;AACA;AACD;;AAED,UAAI1D,IAAJ;;AAEA,cAAQuD,QAAQvD,IAAR,CAAa6C,KAArB;AACE,aAAK,MAAL;AAAc;AAAE7C,mBAAO,MAAP,CAAe;AAAO;AACtC,aAAK,MAAL;AAAc;AAAEA,mBAAO,MAAP,CAAe;AAAO;AACtC,aAAK,OAAL;AAAe;AAAEA,mBAAO,SAAP,CAAkB;AAAO;AAC1C,aAAK,OAAL;AAAe;AAAEA,mBAAO,SAAP,CAAkB;AAAO;AAC1C,aAAK,QAAL;AACA,aAAK,SAAL;AAAgB;AAAEA,mBAAO,KAAP,CAAc;AAAO;AACvC,aAAK,QAAL;AAAgB;AAAEA,mBAAO,QAAP,CAAiB;AAAO;AAC1C,aAAK,SAAL;AAAgB;AAAEA,mBAAO,SAAP,CAAkB;AAAO;AAC3C,aAAK,UAAL;AAAiB;AAAEA,mBAAO,UAAP,CAAmB;AAAO;AAC7C,aAAK,UAAL;AAAiB;AAAEA,mBAAO,UAAP,CAAmB;AAAO;AAC7C,aAAK,OAAL;AAAc;AAAEA,mBAAO,QAAP,CAAiB;AAAO;AAX1C;;AAcA,UAAI,CAACA,IAAL,EAAW;AAAE;AAAU;;AAEvB,UAAIwC,SAAS,EAAExC,IAAF,EAAb;;AAEAwC,aAAOkB,OAAP,GAAiB,EAAEH,QAAQF,IAAR,KAAiB,IAAnB,CAAjB;;AAEA,UAAI,YAAYE,OAAhB,EAAyB;AACvBf,eAAOmB,MAAP,GAAgBJ,QAAQI,MAAR,KAAmB,IAAnC;AACD;;AAEDhB,aAAQY,QAAQ9B,MAAhB,IAA2Be,MAA3B;AACD;;AAED,WAAOG,MAAP;AACD,G;;OAEDiB,gB,GAAmB,CAACC,MAAD,EAASC,IAAT,KAAkB;AACnC,UAAMlD,aAAa,KAAKA,UAAxB;AACA,UAAMmD,kBAAkB,KAAK/B,iBAA7B;AACA,UAAMgC,WAAW,EAAjB;;AAEA,SAAK,IAAI9D,YAAT,IAAyB6D,eAAzB,EAA0C;AACxC,UAAInB,WAAWhC,WAAYV,YAAZ,CAAf;AACA,UAAI+D,UAAUrB,SAAS5C,IAAT,KAAkB,sBAAYkE,KAA5C;AACA,UAAI/C,OAAO8C,UAAU,MAAV,GAAmB,KAA9B;;AAEA,UAAI,CAAC,CAACrB,SAASuB,IAAX,IAAmBhD,QAAQyB,SAASuB,IAAxC,EAA8C;AAC5CH,iBAAS1B,IAAT,CAAc8B,aAAalE,YAAb,EAA2B+D,OAA3B,EAAoCrB,SAASuB,IAAT,CAAehD,IAAf,CAApC,CAAd;AACD;AACF;;AAED,QAAI,CAAC6C,SAASK,MAAd,EAAsB;AACpB,aAAOC,QAAQC,OAAR,CAAgBV,MAAhB,CAAP;AACD;;AAED;AACA,WAAOS,QAAQE,GAAR,CAAYR,QAAZ,EAAsBS,IAAtB,CAA2B,MAAMZ,MAAjC,CAAP;;AAEA,aAASO,YAAT,CAAsBlE,YAAtB,EAAoC+D,OAApC,EAA6CS,GAA7C,EAAkD;AAChD,YAAMvD,OAAOjB,aAAayE,KAAb,CAAmB,CAAnB,EAAsBzE,aAAa0E,WAAb,CAAyB,GAAzB,CAAtB,CAAb;AACA,YAAMC,WAAW,EAAjB;AACA,YAAMhC,QAAQ,oBAAIC,IAAJ,CAAS5C,YAAT,EAAuB2D,MAAvB,CAAd;;AAEA,UAAII,OAAJ,EAAa;AACXY,iBAAStD,EAAT,GAAc,EAAEuD,IAAIjC,KAAN,EAAd;AACD,OAFD,MAEO;AACLgC,iBAAStD,EAAT,GAAcsB,KAAd;AACD;;AAED,aAAOiB,kBAAUY,GAAV,IAAeG,QAAf,KACJJ,IADI,CACCN,QAAQ;AACZ,YAAIF,OAAJ,EAAa;AACX,iBAAOJ,OAAQ1C,IAAR,IAAiBgD,IAAxB;AACD,SAFD,MAEO;AACL,iBAAOxC,OAAOI,MAAP,CAAc8B,OAAQ1C,IAAR,CAAd,EAA8BgD,IAA9B,CAAP;AACD;AACF,OAPI,CAAP;AAQD;AACF,G;;OAEDY,iB,GAAoBC,WAAW,CAAE,C;;;AAGnC,SAASlD,YAAT,CAAsBX,IAAtB,EAA4B;AAC1B,MAAI,CAAC,CAACA,KAAK8D,OAAL,CAAa,GAAb,CAAN,EAAyB;AACvB,WAAO9D,IAAP;AACD;;AAED,SAAOA,KAAKE,OAAL,CAAa,WAAb,EAA0B6D,SAASA,MAAMP,KAAN,CAAY,CAAZ,EAAeQ,WAAf,EAAnC,CAAP;AACD;;AAED,SAASjD,aAAT,CAAuBQ,KAAvB,EAA8B9B,UAA9B,EAA0CE,UAA1C,EAAsD;AACpD,SAAO4B,MAAMb,MAAN,CAAa,CAACc,MAAD,EAASzC,YAAT,KAA0B;AAC5C,UAAM0C,WAAWhC,WAAYV,YAAZ,CAAjB;;AAEA,QAAIkF,gBAAgBxC,SAAS9B,UAA7B;;AAEA,QAAIsE,kBAAkBrE,SAAtB,EAAiC;AAC/BqE,sBAAgB,IAAhB;AACD;;AAED,QAAI,sBAAUA,aAAV,CAAJ,EAA8B;AAC5BA,sBAAgBtE,WAAWe,MAAX,CAAkB,CAACc,MAAD,EAAS0C,SAAT,KAAuB;AACvD1C,eAAQ0C,SAAR,IAAsBD,aAAtB;AACA,eAAOzC,MAAP;AACD,OAHe,EAGb,EAHa,CAAhB;AAID;;AAED;AACA;AACA,QAAI,sBAASyC,aAAT,KAA2BpE,MAAMC,OAAN,CAAcmE,aAAd,CAA/B,EAA6D;AAC3D,UAAIE,OAAO,sBAASF,aAAT,IAA0BA,cAAcG,KAAd,CAAoB,GAApB,CAA1B,GAAqDH,aAAhE;AACAA,sBAAgBE,KAAKzD,MAAL,CAAY,CAACc,MAAD,EAASxB,IAAT,KAAkB;AAC5C,YAAIqE,SAAS,CAAC,CAAC,CAACrE,KAAK8D,OAAL,CAAa,GAAb,CAAhB;;AAEA,YAAI,CAAC,CAAC9D,KAAK8D,OAAL,CAAa,GAAb,CAAN,EAAyB;AACvBtC,iBAAQxB,IAAR,IAAiB,IAAjB;AACD;;AAED,eAAOwB,MAAP;AACD,OARe,EAQb,EARa,CAAhB;AASD;;AAED,QAAI,CAAC,sBAAcyC,aAAd,CAAL,EAAmC;AACjC,YAAMtF,mBAAmB;AACvBI,sBAAe,IAAGA,YAAc,cADT;AAEvBC,sBAAc;AAFS,OAAnB,CAAN;AAID;;AAED,WAAOW,WAAWe,MAAX,CAAkB,CAACc,MAAD,EAAS0C,SAAT,KAAuB;AAC9C1C,aAAQ0C,SAAR,IAAsB1C,OAAQ0C,SAAR,KAAuB,EAA7C;;AAEA;AACA;AACA,UACEA,cAAc,MAAd,KAAyB,EAAEA,aAAaD,aAAf,KAAiCA,cAAeC,SAAf,MAA+B,KAAzF,KACGA,aAAaD,aAAb,IAA8BA,cAAeC,SAAf,MAA+B,IAFlE,EAGE;AACA1C,eAAQ0C,SAAR,EAAoB/C,IAApB,CAAyBM,SAASnB,MAAlC;AACD;;AAED,aAAOkB,MAAP;AACD,KAbM,EAaJA,MAbI,CAAP;AAcD,GApDM,EAoDJ,EAAE8C,MAAM,EAAR,EApDI,CAAP;AAqDD;;AAED;;;;AAIA,SAASrE,YAAT,CAAsBD,IAAtB,EAA4B;AAC1B,SAAOA,KAAKuE,iBAAL,EAAP;AACD","file":"schema.js","sourcesContent":["import os from 'os';\nimport Joi from 'joi';\nimport WrappedError from 'error/wrapped';\nimport TypedError from 'error/typed';\nimport dot from 'dot-object';\nimport isString from 'lodash.isstring';\nimport isPlainObject from 'lodash.isplainobject';\nimport isBoolean from 'lodash.isboolean';\nimport uniq from 'lodash.uniq';\nimport SchemaTypes from './schema-types';\nimport sqlStringProtector from './sql-string-protector';\n\nconst PropertyMustBeType = TypedError({\n  message     : '{name} - свойство \"{propertyName}\" должно быть \"{propertyType}\"',\n  type        : 'micro.plugins.dal.schema.property.must.be.type',\n  code        : 400,\n  propertyName: null,\n  propertyType: null\n});\n\nconst DetectedSqlInjectionError = TypedError({\n  message      : '{name} - обнаружена потенциальная SQL инъекция в свойстве \"{propertyName}\"',\n  type         : 'micro.plugins.dal.schema.detected.sql.injection',\n  code         : 500,\n  propertyName : null,\n  propertyValue: null\n});\n\nconst ValidateError = WrappedError({\n  message      : '{name} - ошибка валидации свойства {propertyName} - {origMessage}',\n  type         : 'micro.plugins.dal.schema.validate.error',\n  code         : 400,\n  propertyName : null,\n  propertyValue: null\n});\n\nexport const Types = SchemaTypes;\nexport const FIELDS_MASK = [ 'full' ];\n\nexport default class Schema {\n  tableName = undefined;\n\n  constructor(modelName, properties = { }, { tableName, fieldsMask } = { }) {\n    if (!isString(modelName)) {\n      throw PropertyMustBeType({ propertyName: 'modelName', propertyType: 'string' });\n    }\n\n    if (fieldsMask !== undefined\n      && (!Array.isArray(fieldsMask) || fieldsMask.some(name => !isString(name)))\n    ) {\n      throw PropertyMustBeType({ propertyName: 'fieldsMask', propertyType: 'array<string>' });\n    }\n\n    if (!isString(tableName)) {\n      throw PropertyMustBeType({ propertyName: 'tableName', propertyType: 'string' });\n    }\n\n    this.fieldsMask = uniq([ ...FIELDS_MASK, ...(fieldsMask || []) ]);\n    this.tableName = (tableName || getTableName(modelName)).replace(/-/g, '_');\n    this.dbProperties = {};\n\n    this.properties = {\n      id: {\n        type         : SchemaTypes.number,\n        name         : 'id',\n        dbName       : 'id',\n        autoincrement: true\n      },\n      ...(Object\n        .keys(properties)\n        .reduce((properties, name) => {\n          let dbName = nameToDbName(name);\n          this.dbProperties[ dbName ] = Object.assign(properties[ name ], { name, dbName });\n          return properties;\n        }, properties))\n    };\n    this.dbProperties.id = this.properties.id;\n    this.__propertiesNames = Object.keys(this.properties);\n    this.__masks = getFieldsMask(this.__propertiesNames, this.properties, this.fieldsMask);\n  }\n\n  getMyFields = (fields) => {\n    // Если в свойстве fields строка - берем заранее заготовленный список пло маске\n    if (isString(fields)) {\n      if (!!this.__masks[ fields ]) {\n        return this.__masks[ fields ];\n      }\n\n      fields = undefined;\n    }\n\n    if (fields === undefined) {\n      fields = [ 'id' ];\n    }\n\n    if (Array.isArray(fields)) {\n      return fields.reduce((fields, name) => {\n        if (this.has(name)) {\n          fields.push(name);\n        }\n        return fields;\n      }, []);\n    }\n  };\n\n  setParams = (params) => {\n    let schema = this;\n    let names = Object.keys(schema.properties);\n    let result = {};\n\n    for(let propertyName of names) {\n      let property = schema.properties[ propertyName ];\n      let value = dot.pick(propertyName, params) || dot.pick(property.dbName, params);\n      \n      if (value === undefined) {\n        continue;\n      }\n\n      if (!sqlStringProtector(value)) {\n        throw DetectedSqlInjectionError({ propertyName, propertyValue: value });\n      }\n\n      if ('convertIn' in property.type) {\n        value = property.type.convertIn(value);\n      }\n      \n      let valid = schema.validate(propertyName, value);\n\n      if (valid.error) {\n        throw valid.error;\n      }\n\n      result[ property.dbName ] = valid.value;\n    }\n\n    return result;\n  };\n\n  getMyCriteriaParams = (params = {}) => {\n    let schema = this;\n    let result = Object.keys(schema.properties).reduce(reduce, {});\n    return result;\n\n    function reduce(result, propertyName) {\n      let property = schema.properties[ propertyName ];\n      let value = dot.pick(propertyName, params) || dot.pick(property.dbName, params);\n\n      if (value !== undefined) {\n        result[ property.dbName ] = value;\n      }\n\n      return result;\n    }\n  };\n\n  has = (property) => {\n    return isString(property) && !!this.properties[ property ];\n  };\n\n  validate = (propertyName, value) => {\n    const props = this.properties[ propertyName ];\n    if (!props) { return false }\n\n    if ('null' in props && props.null === true && (value === null || value === '')) {\n      return {\n        value,\n        error: undefined\n      };\n    }\n\n    const valid = Joi.validate(value, props.type.schema(props));\n\n    if (valid.error) {\n      valid.error = ValidateError(valid.error, { propertyName, propertyValue: value });\n    }\n\n    return valid;\n  };\n\n  migrateCreateTableSchema = () => {\n    const fields = Object.keys(this.properties);\n    const result = {};\n\n    for(let name of fields) {\n      let options = this.properties[ name ];\n\n      if (name === 'id') {\n        result[ name ] = { type: 'int', primaryKey: true, autoIncrement: true, notNull: true };\n        continue;\n      }\n\n      let type;\n\n      switch (options.type.value) {\n        case 'date' : { type = 'date'; break }\n        case 'text' : { type = 'text'; break }\n        case 'float' : { type = 'decimal'; break }\n        case 'money' : { type = 'decimal'; break }\n        case 'number' :\n        case 'integer': { type = 'int'; break }\n        case 'string' : { type = 'string'; break }\n        case 'boolean': { type = 'boolean'; break }\n        case 'smallint': { type = 'smallint'; break }\n        case 'datetime': { type = 'datetime'; break }\n        case 'array': { type = 'string'; break }\n      }\n\n      if (!type) { continue }\n\n      let params = { type };\n\n      params.notNull = !(options.null === true);\n\n      if ('unique' in options) {\n        params.unique = options.unique === true;\n      }\n\n      result[ options.dbName ] = params;\n    }\n\n    return result;\n  };\n  \n  assignLinksToOne = (record, exec) => {\n    const properties = this.properties;\n    const propertiesNames = this.__propertiesNames;\n    const promises = [];\n    \n    for (let propertyName of propertiesNames) {\n      let property = properties[ propertyName ];\n      let hasMany = property.type === SchemaTypes.array;\n      let name = hasMany ? 'list' : 'one';\n  \n      if (!!property.link && name in property.link) {\n        promises.push(__assignLink(propertyName, hasMany, property.link[ name ]));\n      }\n    }\n\n    if (!promises.length) {\n      return Promise.resolve(record);\n    }\n  \n    // Получаем все связанные объекты и сетим их себе\n    return Promise.all(promises).then(() => record);\n  \n    function __assignLink(propertyName, hasMany, pin) {\n      const name = propertyName.slice(0, propertyName.lastIndexOf('.'));\n      const criteria = {};\n      const value = dot.pick(propertyName, record);\n    \n      if (hasMany) {\n        criteria.id = { in: value };\n      } else {\n        criteria.id = value;\n      }\n    \n      return exec({ ...pin, criteria })\n        .then(link => {\n          if (hasMany) {\n            return record[ name ] = link;\n          } else {\n            return Object.assign(record[ name ], link);\n          }\n        });\n    }\n  };\n  \n  assignLinksToMany = records => {};\n}\n\nfunction nameToDbName(name) {\n  if (!~name.indexOf('.')) {\n    return name;\n  }\n\n  return name.replace(/\\.\\w{1}/gi, match => match.slice(1).toUpperCase());\n}\n\nfunction getFieldsMask(names, properties, fieldsMask) {\n  return names.reduce((result, propertyName) => {\n    const property = properties[ propertyName ];\n\n    let propertyMasks = property.fieldsMask;\n\n    if (propertyMasks === undefined) {\n      propertyMasks = true;\n    }\n\n    if (isBoolean(propertyMasks)) {\n      propertyMasks = fieldsMask.reduce((result, fieldMask) => {\n        result[ fieldMask ] = propertyMasks;\n        return result;\n      }, {});\n    }\n\n    // Если указали в формате строки - разобьем ее по сепаратору и преобразуем к объекту\n    // Если указали в формате массива - преобразуем к объекту\n    if (isString(propertyMasks) || Array.isArray(propertyMasks)) {\n      let list = isString(propertyMasks) ? propertyMasks.split(':') : propertyMasks;\n      propertyMasks = list.reduce((result, name) => {\n        let hasNot = !!~name.indexOf('!');\n        \n        if (!~name.indexOf('!')) {\n          result[ name ] = true;\n        }\n        \n        return result;\n      }, {});\n    }\n\n    if (!isPlainObject(propertyMasks)) {\n      throw PropertyMustBeType({\n        propertyName: `${ propertyName }.fieldsMask`,\n        propertyType: 'string | array<string> | object'\n      });\n    }\n\n    return fieldsMask.reduce((result, fieldMask) => {\n      result[ fieldMask ] = result[ fieldMask ] || [];\n      \n      // Если в описании свойства указали fieldsMask\n      // И указанное значение равно true - добавим его во все маски\n      if (\n        fieldMask === 'full' && (!(fieldMask in propertyMasks) || propertyMasks[ fieldMask ] !== false)\n        || fieldMask in propertyMasks && propertyMasks[ fieldMask ] === true\n      ) {\n        result[ fieldMask ].push(property.dbName);\n      }\n\n      return result;\n    }, result);\n  }, { full: [] });\n}\n\n/**\n * @param {string} name\n * @returns {string}\n */\nfunction getTableName(name) {\n  return name.toLocaleLowerCase();\n}"]}