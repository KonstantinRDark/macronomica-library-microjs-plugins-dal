{"version":3,"sources":["../../src/utils/schema.js"],"names":["Types","Schema","constructor","modelName","properties","tableName","undefined","getMyFields","fields","reduce","name","has","push","getMyParams","params","Object","keys","result","property","validate","value","props","type","convertIn","Boolean","null","error","valid","schema","code","message","migrateCreateTableSchema","options","primaryKey","autoIncrement","notNull","unique","getTableName","id","number","autoincrement","toLocaleLowerCase"],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;;;AAEO,MAAMA,6CAAN;;AAEQ,MAAMC,MAAN,CAAa;;AAG1BC,cAAYC,SAAZ,EAA8D;AAAA;;AAAA,QAAvCC,UAAuC,uEAA1B,EAA0B;;AAAA,mFAAL,EAAK;;AAAA,QAAnBC,SAAmB,QAAnBA,SAAmB;AAAA,SAF9DA,SAE8D,GAFlDC,SAEkD;;AAAA,SAW9DC,WAX8D,GAWhD;AAAA,UAACC,MAAD,uEAAU,CAAE,IAAF,CAAV;AAAA,aAAuBA,OAAOC,MAAP,CAAc,CAACD,MAAD,EAASE,IAAT,KAAkB;AACnE,YAAI,MAAKC,GAAL,CAASD,IAAT,CAAJ,EAAoB;AAClBF,iBAAOI,IAAP,CAAYF,IAAZ;AACD;AACD,eAAOF,MAAP;AACD,OALoC,EAKlC,EALkC,CAAvB;AAAA,KAXgD;;AAAA,SAkB9DK,WAlB8D,GAkBhD;AAAA,UAACC,MAAD,uEAAU,EAAV;AAAA,aAAiBC,OAAOC,IAAP,CAAYF,MAAZ,EAAoBL,MAApB,CAA2B,CAACQ,MAAD,EAASP,IAAT,KAAkB;AAC1E,YAAI,MAAKC,GAAL,CAASD,IAAT,CAAJ,EAAoB;AAClBO,iBAAQP,IAAR,IAAiBI,OAAQJ,IAAR,CAAjB;AACD;AACD,eAAOI,MAAP;AACD,OAL8B,EAK5B,EAL4B,CAAjB;AAAA,KAlBgD;;AAAA,SAyB9DH,GAzB8D,GAyBvDO,QAAD,IAAc;AAClB,aAAO,CAAC,CAAC,KAAKd,UAAL,CAAiBc,QAAjB,CAAT;AACD,KA3B6D;;AAAA,SA6B9DC,QA7B8D,GA6BnD,CAACD,QAAD,EAAWE,KAAX,KAAqB;AAC9B,YAAMC,QAAQ,KAAKjB,UAAL,CAAiBc,QAAjB,CAAd;AACA,UAAI,CAACG,KAAL,EAAY;AAAE,eAAO,KAAP;AAAc;;AAE5B,UAAI,eAAeA,MAAMC,IAAzB,EAA+B;AAC7BF,gBAAQC,MAAMC,IAAN,CAAWC,SAAX,CAAqBH,KAArB,EAA4BC,KAA5B,CAAR;AACD;;AAED,UAAI,UAAUA,KAAV,IAAmBG,QAAQH,MAAMI,IAAd,MAAwB,IAA3C,IAAmDL,UAAU,IAAjE,EAAuE;AACrE,eAAO;AACLA,eADK;AAELM,iBAAOpB;AAFF,SAAP;AAID;;AAED,YAAMqB,QAAQ,cAAIR,QAAJ,CAAaC,KAAb,EAAoBC,MAAMC,IAAN,CAAWM,MAAX,CAAkBP,KAAlB,CAApB,CAAd;;AAEA,UAAIM,MAAMD,KAAV,EAAiB;AACf,eAAO;AACLN,iBAAOO,MAAMP,KADR;AAELM,iBAAO;AACLG,kBAAS,kBADJ;AAELC,qBAAU,IAAGZ,QAAU,OAAKS,MAAMD,KAAN,CAAYI,OAAS;AAF5C;AAFF,SAAP;AAOD;;AAED,aAAOH,KAAP;AACD,KAzD6D;;AAAA,SA2D9DI,wBA3D8D,GA2DnC,MAAM;AAC/B,YAAMvB,SAASO,OAAOC,IAAP,CAAY,KAAKZ,UAAjB,CAAf;AACA,YAAMa,SAAS,EAAf;;AAEA,WAAI,IAAIP,IAAR,IAAgBF,MAAhB,EAAwB;AACtB,YAAIwB,UAAU,KAAK5B,UAAL,CAAiBM,IAAjB,CAAd;;AAEA,YAAIA,SAAS,IAAb,EAAmB;AACjBO,iBAAQP,IAAR,IAAiB,EAAEY,MAAM,KAAR,EAAeW,YAAY,IAA3B,EAAiCC,eAAe,IAAhD,EAAsDC,SAAS,IAA/D,EAAjB;AACA;AACD;;AAED,YAAIb,IAAJ;;AAEA,gBAAQU,QAAQV,IAAR,CAAaF,KAArB;AACE,eAAK,MAAL;AAAc;AAAEE,qBAAO,MAAP,CAAe;AAAO;AACtC,eAAK,MAAL;AAAc;AAAEA,qBAAO,MAAP,CAAe;AAAO;AACtC,eAAK,OAAL;AAAe;AAAEA,qBAAO,SAAP,CAAkB;AAAO;AAC1C,eAAK,OAAL;AAAe;AAAEA,qBAAO,SAAP,CAAkB;AAAO;AAC1C,eAAK,QAAL;AACA,eAAK,SAAL;AAAgB;AAAEA,qBAAO,KAAP,CAAc;AAAO;AACvC,eAAK,QAAL;AAAgB;AAAEA,qBAAO,QAAP,CAAiB;AAAO;AAC1C,eAAK,SAAL;AAAgB;AAAEA,qBAAO,SAAP,CAAkB;AAAO;AAC3C,eAAK,UAAL;AAAiB;AAAEA,qBAAO,UAAP,CAAmB;AAAO;AAC7C,eAAK,UAAL;AAAiB;AAAEA,qBAAO,UAAP,CAAmB;AAAO;AAC7C,eAAK,OAAL;AAAc;AAAEA,qBAAO,QAAP,CAAiB;AAAO;AAX1C;;AAcA,YAAI,CAACA,IAAL,EAAW;AAAE;AAAU;;AAEvB,YAAIR,SAAS,EAAEQ,IAAF,EAAb;;AAEAR,eAAOqB,OAAP,GAAiB,EAAEH,QAAQP,IAAR,KAAiB,IAAnB,CAAjB;;AAEA,YAAI,YAAYO,OAAhB,EAAyB;AACvBlB,iBAAOsB,MAAP,GAAgBJ,QAAQI,MAAR,KAAmB,IAAnC;AACD;;AAEDnB,eAAQP,IAAR,IAAiBI,MAAjB;AACD;;AAED,aAAOG,MAAP;AACD,KArG6D;;AAC5D,SAAKZ,SAAL,GAAiBA,aAAagC,aAAalC,SAAb,CAA9B;AACA,SAAKC,UAAL;AACEkC,UAAI;AACFhB,cAAe,sBAAYiB,MADzB;AAEFC,uBAAe;AAFb;AADN,OAKKpC,UALL;AAOD;;AAZyB;;kBAAPH,M,EA2GrB;;;;;AAIA,SAASoC,YAAT,CAAsB3B,IAAtB,EAA4B;AAC1B,SAAOA,KAAK+B,iBAAL,EAAP;AACD","file":"schema.js","sourcesContent":["import Joi from 'joi';\nimport SchemaTypes from './schema-types';\n\nexport const Types = SchemaTypes;\n\nexport default class Schema {\n  tableName = undefined;\n\n  constructor(modelName, properties = { }, { tableName } = { }) {\n    this.tableName = tableName || getTableName(modelName);\n    this.properties = {\n      id: {\n        type         : SchemaTypes.number,\n        autoincrement: true\n      },\n      ...properties\n    };\n  }\n\n  getMyFields = (fields = [ 'id' ]) => fields.reduce((fields, name) => {\n    if (this.has(name)) {\n      fields.push(name);\n    }\n    return fields;\n  }, []);\n\n  getMyParams = (params = {}) => Object.keys(params).reduce((result, name) => {\n    if (this.has(name)) {\n      result[ name ] = params[ name ];\n    }\n    return params;\n  }, {});\n\n  has = (property) => {\n    return !!this.properties[ property ];\n  };\n\n  validate = (property, value) => {\n    const props = this.properties[ property ];\n    if (!props) { return false }\n\n    if ('convertIn' in props.type) {\n      value = props.type.convertIn(value, props);\n    }\n\n    if ('null' in props && Boolean(props.null) === true && value === null) {\n      return {\n        value,\n        error: undefined\n      };\n    }\n\n    const valid = Joi.validate(value, props.type.schema(props));\n\n    if (valid.error) {\n      return {\n        value: valid.value,\n        error: {\n          code   : 'error.dal.params',\n          message: `${ property }: ${ valid.error.message }`\n        }\n      };\n    }\n\n    return valid;\n  };\n\n  migrateCreateTableSchema = () => {\n    const fields = Object.keys(this.properties);\n    const result = {};\n\n    for(let name of fields) {\n      let options = this.properties[ name ];\n\n      if (name === 'id') {\n        result[ name ] = { type: 'int', primaryKey: true, autoIncrement: true, notNull: true };\n        continue;\n      }\n\n      let type;\n\n      switch (options.type.value) {\n        case 'date' : { type = 'date'; break }\n        case 'text' : { type = 'text'; break }\n        case 'float' : { type = 'decimal'; break }\n        case 'money' : { type = 'decimal'; break }\n        case 'number' :\n        case 'integer': { type = 'int'; break }\n        case 'string' : { type = 'string'; break }\n        case 'boolean': { type = 'boolean'; break }\n        case 'smallint': { type = 'smallint'; break }\n        case 'datetime': { type = 'datetime'; break }\n        case 'array': { type = 'string'; break }\n      }\n\n      if (!type) { continue }\n\n      let params = { type };\n\n      params.notNull = !(options.null === true);\n\n      if ('unique' in options) {\n        params.unique = options.unique === true;\n      }\n\n      result[ name ] = params;\n    }\n\n    return result;\n  }\n}\n\n/**\n * @param {string} name\n * @returns {string}\n */\nfunction getTableName(name) {\n  return name.toLocaleLowerCase();\n}"]}