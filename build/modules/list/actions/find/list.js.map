{"version":3,"sources":["../../../../../src/modules/list/actions/find/list.js"],"names":["buildFindList","ERROR_INFO","module","action","app","middleware","plugin","msg","schema","criteria","options","outer","fields","sort","limit","offset","reject","resolve","__fields","getMyFields","builder","tableName","getMyCriteriaParams","select","orderKey","orderDirection","split","includes","toLowerCase","orderBy","then","result","Array","isArray","records","map","assignLinksToMany","pin","act","catch","error"],"mappings":";;;;;;;;;;;;;;QAkBgBA,a,GAAAA,a;;AAlBhB;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;AAMA,MAAMC,aAAa,EAAEC,8BAAF,EAAuBC,QAAQ,WAA/B,EAAnB;;kBAEe,CAACC,GAAD,EAAMC,UAAN,EAAkBC,MAAlB,KAA8BC,GAAD,IAASP,cAAcI,GAAd,EAAmBC,UAAnB,EAA+BE,GAA/B,C;;AAE9C,SAASP,aAAT,CAAuBI,GAAvB,EAA4BC,UAA5B,EAAwCE,GAAxC,EAA6C;AAAA,MAC5CC,MAD4C,GACJD,GADI,CAC5CC,MAD4C;AAAA,sBACJD,GADI,CACpCE,QADoC;AAAA,MACpCA,QADoC,iCACzB,EADyB;AAAA,qBACJF,GADI,CACrBG,OADqB;AAAA,MACrBA,OADqB,gCACX,EADW;AAAA,uBAQ9CA,OAR8C,CAGhDC,KAHgD;AAAA,QAGhDA,KAHgD,kCAGxC,KAHwC;AAAA,QAIhDC,MAJgD,GAQ9CF,OAR8C,CAIhDE,MAJgD;AAAA,sBAQ9CF,OAR8C,CAKhDG,IALgD;AAAA,QAKhDA,IALgD,iCAKzC,IALyC;AAAA,QAMhDC,KANgD,GAQ9CJ,OAR8C,CAMhDI,KANgD;AAAA,QAOhDC,MAPgD,GAQ9CL,OAR8C,CAOhDK,MAPgD;;;AAUlD,MAAI,CAACP,MAAL,EAAa;AACX,WAAO,kBAAQQ,MAAR,CAAe,iCAAoBf,UAApB,CAAf,CAAP;AACD;;AAED,MAAI,EAAEO,kCAAF,CAAJ,EAAiC;AAC/B,WAAO,kBAAQQ,MAAR,CAAe,+CAAkCf,UAAlC,CAAf,CAAP;AACD;;AAED,SAAO,sBAAY,CAACgB,OAAD,EAAUD,MAAV,KAAqB;AACtC,QAAIE,WAAWV,OAAOW,WAAP,CAAmBP,MAAnB,CAAf;AACA,QAAIQ,UAAU,2BACZhB,GADY,EAEZC,WAAWG,OAAOa,SAAlB,CAFY,EAGZb,OAAOc,mBAAP,CAA2Bb,QAA3B,CAHY,EAIZO,MAJY,EAKZO,MALY,CAKL,GAAGL,QALE,CAAd;;AAOA,QAAIL,IAAJ,EAAU;AACR,UAAIW,QAAJ;AACA,UAAIC,cAAJ;;AAEA,UAAI,sBAASZ,IAAT,CAAJ,EAAoB;AAAA,0BACqBA,KAAKa,KAAL,CAAW,GAAX,CADrB;;AAAA;;AAChBF,gBADgB;AAAA;AACNC,sBADM,iCACW,KADX;;;AAGlBA,yBAAiB,CAAE,KAAF,EAAS,MAAT,EAAkBE,QAAlB,CAA2BF,eAAeG,WAAf,EAA3B,IACbH,eAAeG,WAAf,EADa,GAEb,KAFJ;AAGD;;AAED,UAAIJ,YAAYC,cAAhB,EAAgC;AAC9BL,kBAAUA,QAAQS,OAAR,CAAgBL,QAAhB,EAA0BC,cAA1B,CAAV;AACD;AACF;;AAED,QAAIX,SAAS,sBAASA,KAAT,CAAb,EAA8B;AAC5BM,gBAAUA,QAAQN,KAAR,CAAcA,KAAd,CAAV;AACD;;AAED,QAAIC,UAAU,sBAASA,MAAT,CAAd,EAAgC;AAC9BK,gBAAUA,QAAQL,MAAR,CAAeA,MAAf,CAAV;AACD;;AAED,QAAIJ,KAAJ,EAAW;AACT;AACA;AACA,aAAOM,QAAQ,EAAEG,OAAF,EAAR,CAAP;AACD;;AAEDA,YACGU,IADH,CACQ,YAAiB;AAAA,UAAhBC,MAAgB,uEAAP,EAAO;;AACrB,UAAI,CAACA,MAAD,IAAW,CAACC,MAAMC,OAAN,CAAcF,MAAd,CAAhB,EAAuC;AACrC,eAAOA,MAAP;AACD;;AAED,YAAMG,UAAUH,OAAOI,GAAP,CAAW,iCAAkB3B,MAAlB,EAA0BU,QAA1B,CAAX,CAAhB;;AAEA,aAAOV,OACJ4B,iBADI,CACcF,OADd,EACuBG,OAAO9B,IAAI+B,GAAJ,CAAQD,GAAR,CAD9B,EAEJP,IAFI,CAEC,MAAMI,OAFP,CAAP;AAGD,KAXH,EAYGJ,IAZH,CAYQb,OAZR,EAaGsB,KAbH,CAaSC,SAASxB,OAAO,kCAAqBZ,GAArB,EAA0BH,UAA1B,EAAsCuC,KAAtC,CAAP,CAblB;AAcD,GAtDM,CAAP;AAuDD","file":"list.js","sourcesContent":["import dot from 'dot-object';\nimport isString from 'lodash.isstring';\nimport Schema from './../../../../utils/schema';\nimport isNumber from 'lodash.isnumber';\nimport setCriteria from './../../../../utils/set-criteria';\nimport checkLinks from './../../../../utils/check-links';\nimport convertToResponse from './../../../../utils/convert-to-response';\nimport { MODULE_NAME } from './../../constants';\nimport {\n  internalErrorPromise,\n  schemaNotFoundError,\n  schemaNotInstanceSchemaClassError\n} from '../../../../errors';\n\nconst ERROR_INFO = { module: MODULE_NAME, action: 'find-list' };\n\nexport default (app, middleware, plugin) => (msg) => buildFindList(app, middleware, msg);\n\nexport function buildFindList(app, middleware, msg) {\n  let { schema, criteria = {}, options = {} } = msg;\n  const {\n    outer = false,\n    fields,\n    sort = 'id',\n    limit,\n    offset,\n  } = options;\n\n  if (!schema) {\n    return Promise.reject(schemaNotFoundError(ERROR_INFO));\n  }\n\n  if (!(schema instanceof Schema)) {\n    return Promise.reject(schemaNotInstanceSchemaClassError(ERROR_INFO));\n  }\n\n  return new Promise((resolve, reject) => {\n    let __fields = schema.getMyFields(fields);\n    let builder = setCriteria(\n      app,\n      middleware(schema.tableName),\n      schema.getMyCriteriaParams(criteria),\n      reject\n    ).select(...__fields);\n\n    if (sort) {\n      let orderKey;\n      let orderDirection;\n\n      if (isString(sort)) {\n        [ orderKey, orderDirection = 'asc' ] = sort.split(' ');\n\n        orderDirection = [ 'asc', 'desc' ].includes(orderDirection.toLowerCase())\n          ? orderDirection.toLowerCase()\n          : 'asc';\n      }\n\n      if (orderKey && orderDirection) {\n        builder = builder.orderBy(orderKey, orderDirection);\n      }\n    }\n\n    if (limit && isNumber(limit)) {\n      builder = builder.limit(limit);\n    }\n\n    if (offset && isNumber(offset)) {\n      builder = builder.offset(offset);\n    }\n\n    if (outer) {\n      // Если кто-то сам хочет запускать запрос - вернем builder\n      // Возвращаем как объект - иначе происходит исполнение данного builder'a\n      return resolve({ builder });\n    }\n\n    builder\n      .then((result = []) => {\n        if (!result || !Array.isArray(result)) {\n          return result;\n        }\n\n        const records = result.map(convertToResponse(schema, __fields));\n\n        return schema\n          .assignLinksToMany(records, pin => msg.act(pin))\n          .then(() => records);\n      })\n      .then(resolve)\n      .catch(error => reject(internalErrorPromise(app, ERROR_INFO)(error)));\n  });\n}"]}