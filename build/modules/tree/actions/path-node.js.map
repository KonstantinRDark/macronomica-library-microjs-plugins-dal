{"version":3,"sources":["../../../../src/modules/tree/actions/path-node.js"],"names":["buildPathTreeNode","ERROR_INFO","module","action","app","middleware","plugin","msg","schema","criteria","options","id","parents","Promise","resolve","reject","act","fields","then","parent","parentId","childrenPath","sort","a","b","catch","push"],"mappings":";;;;;;;;QAagBA,iB,GAAAA,iB;;AAbhB;;;;AACA;;AACA;;AACA;;;;AAMA,MAAMC,aAAa,EAAEC,+BAAF,EAAuBC,QAAQ,WAA/B,EAAnB;;kBAEe,CAACC,GAAD,EAAMC,UAAN,EAAkBC,MAAlB,KAA8BC,GAAD,IAASP,kBAAkBI,GAAlB,EAAuBC,UAAvB,EAAmCE,GAAnC,C;;AAE9C,SAASP,iBAAT,CAA2BI,GAA3B,EAAgCC,UAAhC,QAAqF;AAAA,MAAvCG,MAAuC,QAAvCA,MAAuC;AAAA,2BAA/BC,QAA+B;AAAA,MAA/BA,QAA+B,iCAApB,EAAoB;AAAA,0BAAhBC,OAAgB;AAAA,MAAhBA,OAAgB,gCAAN,EAAM;AAAA,QAClFC,EADkF,GAC3EF,QAD2E,CAClFE,EADkF;;AAE1F,QAAMC,UAAU,EAAhB;;AAEA,MAAI,CAACD,EAAL,EAAS;AACP,WAAOE,QAAQC,OAAR,CAAgBF,OAAhB,CAAP;AACD;;AAED,MAAI,CAACJ,MAAL,EAAa;AACX,WAAOK,QAAQE,MAAR,CAAe,iCAAoBd,UAApB,CAAf,CAAP;AACD;;AAED,MAAI,EAAEO,kCAAF,CAAJ,EAAiC;AAC/B,WAAOK,QAAQE,MAAR,CAAe,+CAAkCd,UAAlC,CAAf,CAAP;AACD;;AAED;AACA,SAAOG,IACJY,GADI,8CACwBR,MADxB,EACgCC,UAAU,EAAEE,EAAF,EAD1C,EACkDD,SAAS,EAAEO,QAAQ,CAAE,IAAF,EAAQ,UAAR,CAAV,EAD3D,KAEJC,IAFI,CAECC,UAAU;AAAA,UACNC,QADM,GACOD,MADP,CACNC,QADM;;AAGd;;AACA,QAAI,CAACA,QAAL,EAAe;AACb,aAAOR,OAAP;AACD;;AAED;AACA,WAAOS,aAAajB,GAAb,EAAkBI,MAAlB,EAA0BY,QAA1B,EAAoCR,OAApC,CAAP;AACD,GAZI,EAaJM,IAbI,CAaCN,WAAWA,QAAQU,IAAR,CAAa,CAACC,CAAD,EAAIC,CAAJ,KAAUD,EAAEZ,EAAF,GAAOa,EAAEb,EAAhC,CAbZ,EAcJc,KAdI,CAcE,2BAAcrB,GAAd,EAAmBH,UAAnB,CAdF,CAAP;AAeD;;AAED;AACA;AACA;AACA,SAASoB,YAAT,CAAsBjB,GAAtB,EAA2BI,MAA3B,EAA4D;AAAA,MAAzBG,EAAyB,uEAApB,IAAoB;AAAA,MAAdC,OAAc,uEAAJ,EAAI;;AAC1D,SAAOR,IACJY,GADI,8CACwBR,MADxB,EACgCC,UAAU,EAAEE,EAAF,EAD1C,KAEJO,IAFI,CAECC,UAAU;AAAA,UACNC,QADM,GACOD,MADP,CACNC,QADM;;;AAGdR,YAAQc,IAAR,CAAaP,MAAb;;AAEA;AACA,QAAI,CAACC,QAAL,EAAe;AACb,aAAOR,OAAP;AACD;;AAED;AACA,WAAOS,aAAajB,GAAb,EAAkBI,MAAlB,EAA0BY,QAA1B,EAAoCR,OAApC,CAAP;AACD,GAdI,CAAP;AAeD","file":"path-node.js","sourcesContent":["import Schema from './../../../utils/schema';\nimport { PIN_LIST_FIND_ONE } from './../../constants';\nimport { MODULE_NAME } from './../constants';\nimport {\n  internalError,\n  schemaNotFoundError,\n  schemaNotInstanceSchemaClassError\n} from '../../../errors';\n\nconst ERROR_INFO = { module: MODULE_NAME, action: 'path-node' };\n\nexport default (app, middleware, plugin) => (msg) => buildPathTreeNode(app, middleware, msg);\n\nexport function buildPathTreeNode(app, middleware, { schema, criteria = {}, options = {} }) {\n  const { id } = criteria;\n  const parents = [];\n\n  if (!id) {\n    return Promise.resolve(parents);\n  }\n\n  if (!schema) {\n    return Promise.reject(schemaNotFoundError(ERROR_INFO));\n  }\n\n  if (!(schema instanceof Schema)) {\n    return Promise.reject(schemaNotInstanceSchemaClassError(ERROR_INFO));\n  }\n\n  // Загружаем себя\n  return app\n    .act({ ...PIN_LIST_FIND_ONE, schema, criteria: { id }, options: { fields: [ 'id', 'parentId' ] } })\n    .then(parent => {\n      const { parentId } = parent;\n\n      // Если нет родителей - вернем пустой массив родителей\n      if (!parentId) {\n        return parents;\n      }\n\n      // Иначе запустим загрузку родителей\n      return childrenPath(app, schema, parentId, parents);\n    })\n    .then(parents => parents.sort((a, b) => a.id - b.id))\n    .catch(internalError(app, ERROR_INFO));\n}\n\n// Загружаем одну ноду по Id\n// Если нет parentId возвращаем родителей\n// Иначе вызовем этот метод с id == parentId\nfunction childrenPath(app, schema, id = null, parents = []) {\n  return app\n    .act({ ...PIN_LIST_FIND_ONE, schema, criteria: { id } })\n    .then(parent => {\n      const { parentId } = parent;\n\n      parents.push(parent);\n\n      // Если нет родителя - вернем список загруженных родителей\n      if (!parentId) {\n        return parents;\n      }\n\n      // Иначе запустим загрузку родителя\n      return childrenPath(app, schema, parentId, parents);\n    });\n}"]}