{"version":3,"sources":["../../../../src/modules/cascade/actions/save-one.js"],"names":["cascadeSaveOne","CascadeSaveInternalError","message","join","EOL","type","propertyName","request","originalName","required","original","params","pins","errors","savePin","save","createPin","create","updatePin","update","SaveError","CreateError","UpdateError","Promise","resolve","reject","meta","name","result","log","info","id","other","act","criteria","e","error"],"mappings":"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","file":"save-one.js","sourcesContent":["import os from 'os';\nimport WrappedError from 'error/wrapped';\nimport { PIN_CASCADE_REMOVE } from '../../../pins';\n\nconst CascadeSaveInternalError = WrappedError({\n  message: [\n    '{name} - Ошибка каскадного сохранения \"{propertyName}\"',\n    '{name} - {origMessage}',\n  ].join(os.EOL),\n  type        : 'micro.plugins.dal.cascade.save.one.internal',\n  propertyName: null\n});\n\nexport default function cascadeSaveOne(request) {\n  const {\n    originalName = 'not.indicated',\n    propertyName = 'not.indicated',\n    required = false,\n    original = {},\n    params,\n    pins = {},\n    errors = {}\n  } = request;\n  const {\n    save:savePin,\n    create:createPin,\n    update:updatePin\n  } = pins;\n  const {\n    save:SaveError,\n    create:CreateError = SaveError,\n    update:UpdateError = SaveError\n  } = errors;\n\n  return new Promise(async (resolve, reject) => {\n    const meta = { request: request.request, required, propertyName, originalName, params };\n    let name = originalName + '.' + propertyName;\n    let result;\n\n    // Сохраним\n    if (!!params) {\n      try {\n\n        if (updatePin && 'id' in params) {\n          request.log.info(`Каскадное обновление \"${ name }\"`, meta);\n          let { id, ...other } = params;\n          result = await request.act({ ...updatePin, params: other, criteria: { id } });\n        }\n        else if (createPin) {\n          request.log.info(`Каскадное создание \"${ name }\"`, meta);\n          result = await request.act({ ...createPin, params });\n        }\n        else if (savePin) {\n          request.log.info(`Каскадное сохранение \"${ name }\"`, meta);\n          result = await request.act({ ...savePin, params });\n        }\n        else {\n          request.log[ required ? 'warn' : 'info' ](\n            `Не передан пин для каскадного (создания && обновления) || сохранения свойства \"${ name }\"`,\n            meta\n          );\n        }\n      }\n      catch (e) {\n        let error;\n\n        if (UpdateError) { error = UpdateError(e, meta) }\n        else if (CreateError) { error = CreateError(e, meta) }\n        else if (SaveError) { error = SaveError(e, meta) }\n        else { error = CascadeSaveInternalError(e, meta) }\n\n        request.log.error(error, meta);\n\n        if (required) {\n          return reject(error);\n        }\n      }\n    }\n\n    // Если передали null или есть оригинал и его id не соответсвует переданной записи\n    if (\n      (params === null && 'id' in original)\n      || ('id' in original && !!params && original.id !== params.id)\n    ) {\n      try {\n        result = await request.act({\n          ...PIN_CASCADE_REMOVE,\n          originalName,\n          propertyName,\n          required,\n          criteria: { id: original.id },\n          pins,\n          errors\n        });\n      }\n      catch (e) {\n        if (required) {\n          return reject(e);\n        }\n      }\n    }\n\n    resolve(result);\n  });\n};"]}