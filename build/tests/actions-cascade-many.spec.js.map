{"version":3,"sources":["../../src/tests/actions-cascade-many.spec.js"],"names":["should","micro","level","plugins","schema","type","number","tableName","before","run","then","act","createTable","after","dropTable","end","describe","CASCADE_SAVE_MANY","required","originalName","propertyName","pins","remove","create","update","it","params","options","fields","result","all","exist","be","a","with","length","have","property","equal","original","id","connection","createTableIfNotExists","table","increments","integer","properties","dbName","dropTableIfExists"],"mappings":"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","file":"actions-cascade-many.spec.js","sourcesContent":["import chai from 'chai';\nimport Micro, { LEVEL_ERROR } from '@microjs/microjs';\nimport { CONNECT_OPTIONS, CONNECT_OPTIONS_PG } from './constants';\nimport Plugin, {\n  Schema,\n  SchemaTypes,\n  PIN_CONNECTION,\n  PIN_CASCADE_SAVE_MANY,\n  PIN_LIST_CREATE,\n  PIN_LIST_UPDATE,\n  PIN_LIST_FIND_LIST,\n  PIN_LIST_REMOVE\n} from '../index';\n\nconst should = chai.should();\nconst micro = Micro({\n  level  : LEVEL_ERROR,\n  plugins: [ Plugin(CONNECT_OPTIONS_PG) ]\n});\n\nconst schema = new Schema('CascadeDependent', {\n  'number': {\n    type: SchemaTypes.number\n  }\n}, {\n  tableName: 'module_cascade_many_dependent_db'\n});\n\nbefore(() => micro\n  .run()\n  .then(() => micro.act(PIN_CONNECTION))\n  .then(createTable)\n);\nafter(() => micro.act(PIN_CONNECTION)\n  .then(dropTable)\n  .then(() => micro.end()));\n\ndescribe('actions-cascade-many', function() {\n  const CASCADE_SAVE_MANY = {\n    ...PIN_CASCADE_SAVE_MANY,\n    required    : false,\n    originalName: 'owner',\n    propertyName: 'preview',\n    pins        : {\n      remove: { ...PIN_LIST_REMOVE, schema },\n      create: { ...PIN_LIST_CREATE, schema },\n      update: { ...PIN_LIST_UPDATE, schema }\n    }\n  };\n\n  it('#save-many (create - 2)', () => micro\n    .act({ ...CASCADE_SAVE_MANY,\n      params: [ { number: 1 }, { number: 2 } ]\n    })\n    .then(() => micro.act({ ...PIN_LIST_FIND_LIST, schema, options: { fields: 'full' } }))\n    .then(result => Promise.all([\n      should.exist(result),\n      result.should.be.a('array').with.length(2),\n      result[ 0 ].should.be.a('object'),\n      result[ 0 ].should.have.property('number').be.a('number').equal(1),\n      result[ 1 ].should.be.a('object'),\n      result[ 1 ].should.have.property('number').be.a('number').equal(2),\n    ]))\n  );\n\n  it('#save-many (create - 1, update - 1, remove - 1)', () => micro\n    .act({ ...CASCADE_SAVE_MANY,\n      original: [ { id: 1, number: 1 }, { id: 2, number: 2 } ],\n      params  : [ { id: 2, number: 3 }, { number: 4 } ]\n    })\n    .then(() => micro.act({ ...PIN_LIST_FIND_LIST, schema, options: { fields: 'full' } }))\n    .then(result => Promise.all([\n      result.should.be.a('array').with.length(2),\n      result[ 0 ].should.be.a('object'),\n      result[ 0 ].should.have.property('number').be.a('number').equal(3),\n      result[ 1 ].should.be.a('object'),\n      result[ 1 ].should.have.property('number').be.a('number').equal(4),\n    ]))\n  );\n\n  it('#save-many (remove - 2)', () => micro\n    .act({ ...CASCADE_SAVE_MANY,\n      original: [ { id: 2, number: 3 }, { id: 3, number: 4 } ],\n      params  : null\n    })\n    .then(() => micro.act({ ...PIN_LIST_FIND_LIST, schema, options: { fields: 'full' } }))\n    .then(result => Promise.all([\n      result.should.be.a('array').with.length(0)\n    ]))\n  );\n\n});\n\nfunction createTable(connection) {\n  return connection.schema.createTableIfNotExists(schema.tableName, function (table) {\n    table.increments();\n    table.integer(schema.properties[ 'number' ].dbName);\n  });\n}\n\nfunction dropTable(connection) {\n  return connection.schema.dropTableIfExists(schema.tableName);\n}\n"]}