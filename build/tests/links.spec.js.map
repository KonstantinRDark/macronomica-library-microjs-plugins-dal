{"version":3,"sources":["../../src/tests/links.spec.js"],"names":["tableName","should","micro","level","plugins","imageSchema","src","type","string","required","alt","null","userSchema","login","number","link","one","schema","options","fields","list","before","run","then","act","createTable","params","img1","img2","img3","img4","icon1","id","icon2","after","dropTable","end","describe","it","Promise","all","criteria","validate","user1","user2","checkOne","user","equal","be","a","have","property","checkIcon","icon","connection","createTableIfNotExists","table","increments","properties","dbName","integer","dropTableIfExists"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;;;AASA,MAAMA,YAAY,iBAAlB;AACA,MAAMC,SAAS,eAAKA,MAAL,EAAf;AACA,MAAMC,QAAQ,uBAAM;AAClBC,6BADkB;AAElBC,WAAS,CAAE,mDAAF;AAFS,CAAN,CAAd;;AAKA,MAAMC,cAAc,kBAAW,OAAX,EAAoB;AACtCC,OAAK,EAAEC,MAAM,mBAAYC,MAApB,EAA4BC,UAAU,IAAtC,EADiC;AAEtCC,OAAK,EAAEH,MAAM,mBAAYC,MAApB,EAA4BG,MAAM,IAAlC;AAFiC,CAApB,EAGjB,EAAEX,WAAW,qBAAb,EAHiB,CAApB;;AAKA,MAAMY,aAAa,kBAAW,MAAX,EAAmB;AACpCC,SAAY,EAAEN,MAAM,mBAAYC,MAApB,EAA4BC,UAAU,IAAtC,EADwB;AAEpC,cAAY;AACVF,UAAM,mBAAYO,MADR;AAEVH,UAAM,IAFI;AAGVI,UAAM;AACJC,oDAA8BC,QAAQZ,WAAtC,EAAmDa,SAAS,EAAEC,QAAQ,MAAV,EAA5D,GADI;AAEJ;AACAC,sDAA+BH,QAAQZ,WAAvC,EAAoDa,SAAS,EAAEC,QAAQ,MAAV,EAA7D;AAHI;AAHI,GAFwB;AAWpC,cAAY;AACVZ,UAAM,mBAAYO,MADR;AAEVH,UAAM,IAFI;AAGVI,UAAM;AACJC,oDAA8BC,QAAQZ,WAAtC,EAAmDa,SAAS,EAAEC,QAAQ,MAAV,EAA5D,GADI;AAEJ;AACAC,sDAA+BH,QAAQZ,WAAvC,EAAoDa,SAAS,EAAEC,QAAQ,MAAV,EAA7D;AAHI;AAHI;AAXwB,CAAnB,EAoBhB,EAAEnB,WAAW,oBAAb,EApBgB,CAAnB;;AAsBAqB,OAAO,MAAMnB,MACVoB,GADU,GAEVC,IAFU,CAEL,MAAMrB,MAAMsB,GAAN,uBAFD,EAGVD,IAHU,CAGLE,WAHK,EAIVF,IAJU,CAIL,MAAMrB,MACTsB,GADS,wCACiBP,QAAQZ,WADzB,EACsCqB,QAAQ,CACtD,EAAEpB,KAAK,8BAAP,EAAuCI,KAAK,YAA5C,EADsD,EAEtD,EAAEJ,KAAK,8BAAP,EAAuCI,KAAK,YAA5C,EAFsD,EAGtD,EAAEJ,KAAK,8BAAP,EAAuCI,KAAK,YAA5C,EAHsD,EAItD,EAAEJ,KAAK,8BAAP,EAAuCI,KAAK,YAA5C,EAJsD,CAD9C,KAOTa,IAPS,CAOJ;AAAA;;AAAA,MAAGI,IAAH;AAAA,MAASC,IAAT;AAAA,MAAeC,IAAf;AAAA,MAAqBC,IAArB;AAAA,SAAgC5B,MAAMsB,GAAN,wCAAgCP,QAAQL,UAAxC,EAAoDc,QAAQ,CAChG,EAAEb,OAAO,OAAT,EAAkBkB,OAAO,EAAEC,IAAIL,KAAKK,EAAX,EAAzB,EAA0CC,OAAO,EAAED,IAAIJ,KAAKI,EAAX,EAAjD,EADgG,EAEhG,EAAEnB,OAAO,OAAT,EAAkBkB,OAAO,EAAEC,IAAIH,KAAKG,EAAX,EAAzB,EAA0CC,OAAO,EAAED,IAAIF,KAAKE,EAAX,EAAjD,EAFgG,CAA5D,IAAhC;AAAA,CAPI,CAJD,CAAb;;AAkBAE,MAAM,MAAMhC,MAAMsB,GAAN,wBACTD,IADS,CACJY,SADI,EAETZ,IAFS,CAEJ,MAAMrB,MAAMkC,GAAN,EAFF,CAAZ;;AAIAC,SAAS,QAAT,EAAmB,YAAW;;AAE5BC,KAAG,WAAH,EAAgB,MAAMC,QAAQC,GAAR,CAAY,CAC9BtC,MAAMsB,GAAN;AACEP,YAAUL,UADZ;AAEEM,aAAU,EAAEC,QAAQ,MAAV,EAFZ;AAGEsB,cAAU,EAAET,IAAI,CAAN;AAHZ,KAD8B,EAM9B9B,MAAMsB,GAAN;AACEP,YAAUL,UADZ;AAEEM,aAAU,EAAEC,QAAQ,MAAV,EAFZ;AAGEsB,cAAU,EAAET,IAAI,CAAN;AAHZ,KAN8B,CAAZ,EAYnBT,IAZmB,CAYdmB,QAZc,CAAtB;;AAeAJ,KAAG,YAAH,EAAiB,MAAMpC,MACpBsB,GADoB,2CACSP,QAAQL,UADjB,EAC6BM,SAAS,EAAEC,QAAQ,MAAV,EADtC,KAEpBI,IAFoB,CAEfmB,QAFe,CAAvB;;AAKA,WAASA,QAAT,GAAyC;AAAA,oFAAJ,EAAI;AAAA;;AAAA,QAArBC,KAAqB;AAAA,QAAdC,KAAc;;AACvC,WAAOL,QAAQC,GAAR,CAAY,CACjB,GAAGK,SAASF,KAAT,EAAgB;AACjBX,UAAO,CADU;AAEjBnB,aAAO,OAFU;AAGjBkB,aAAO,EAAEC,IAAI,CAAN,EAAS1B,KAAK,8BAAd,EAA8CI,KAAK,YAAnD,EAHU;AAIjBuB,aAAO,EAAED,IAAI,CAAN,EAAS1B,KAAK,8BAAd,EAA8CI,KAAK,YAAnD;AAJU,KAAhB,CADc,EAOjB,GAAGmC,SAASD,KAAT,EAAgB;AACjBZ,UAAO,CADU;AAEjBnB,aAAO,OAFU;AAGjBkB,aAAO,EAAEC,IAAI,CAAN,EAAS1B,KAAK,8BAAd,EAA8CI,KAAK,YAAnD,EAHU;AAIjBuB,aAAO,EAAED,IAAI,CAAN,EAAS1B,KAAK,8BAAd,EAA8CI,KAAK,YAAnD;AAJU,KAAhB,CAPc,CAAZ,CAAP;AAcD;;AAED,WAASmC,QAAT,CAAkBC,IAAlB,EAAwBC,KAAxB,EAA+B;AAC7B,WAAO,CACLD,KAAK7C,MAAL,CAAY+C,EAAZ,CAAeC,CAAf,CAAiB,QAAjB,CADK,EAELH,KAAK7C,MAAL,CAAYiD,IAAZ,CAAiBC,QAAjB,CAA0B,IAA1B,EAAgCH,EAAhC,CAAmCC,CAAnC,CAAqC,QAArC,EAA+CF,KAA/C,CAAqDA,MAAMf,EAA3D,CAFK,EAGLc,KAAK7C,MAAL,CAAYiD,IAAZ,CAAiBC,QAAjB,CAA0B,OAA1B,EAAmCH,EAAnC,CAAsCC,CAAtC,CAAwC,QAAxC,EAAkDF,KAAlD,CAAwDA,MAAMlC,KAA9D,CAHK,EAIL,GAAGuC,UAAUN,KAAKf,KAAf,EAAsBgB,MAAMhB,KAA5B,CAJE,EAKL,GAAGqB,UAAUN,KAAKb,KAAf,EAAsBc,MAAMd,KAA5B,CALE,CAAP;AAOD;;AAED,WAASmB,SAAT,CAAmBC,IAAnB,EAAyBN,KAAzB,EAAgC;AAC9B,WAAO,CACLM,KAAKpD,MAAL,CAAY+C,EAAZ,CAAeC,CAAf,CAAiB,QAAjB,CADK,EAELI,KAAKpD,MAAL,CAAYiD,IAAZ,CAAiBC,QAAjB,CAA0B,IAA1B,EAAgCH,EAAhC,CAAmCC,CAAnC,CAAqC,QAArC,EAA+CF,KAA/C,CAAqDA,MAAMf,EAA3D,CAFK,EAGLqB,KAAKpD,MAAL,CAAYiD,IAAZ,CAAiBC,QAAjB,CAA0B,KAA1B,EAAiCH,EAAjC,CAAoCC,CAApC,CAAsC,QAAtC,EAAgDF,KAAhD,CAAsDA,MAAMzC,GAA5D,CAHK,EAIL+C,KAAKpD,MAAL,CAAYiD,IAAZ,CAAiBC,QAAjB,CAA0B,KAA1B,EAAiCH,EAAjC,CAAoCC,CAApC,CAAsC,QAAtC,EAAgDF,KAAhD,CAAsDA,MAAMrC,GAA5D,CAJK,CAAP;AAMD;AACF,CAzDD;;AA4DA,SAASe,WAAT,CAAqB6B,UAArB,EAAiC;AAC/B,SAAOf,QAAQC,GAAR,CAAY,CACjBc,WAAWrC,MAAX,CAAkBsC,sBAAlB,CAAyClD,YAAYL,SAArD,EAAgE,UAAUwD,KAAV,EAAiB;AAC/EA,UAAMC,UAAN;AACAD,UAAMhD,MAAN,CAAaH,YAAYqD,UAAZ,CAAwB,KAAxB,EAAgCC,MAA7C;AACAH,UAAMhD,MAAN,CAAaH,YAAYqD,UAAZ,CAAwB,KAAxB,EAAgCC,MAA7C;AACD,GAJD,CADiB,EAMjBL,WAAWrC,MAAX,CAAkBsC,sBAAlB,CAAyC3C,WAAWZ,SAApD,EAA+D,UAAUwD,KAAV,EAAiB;AAC9EA,UAAMC,UAAN;AACAD,UAAMhD,MAAN,CAAaI,WAAW8C,UAAX,CAAuB,OAAvB,EAAiCC,MAA9C;AACAH,UAAMI,OAAN,CAAchD,WAAW8C,UAAX,CAAuB,UAAvB,EAAoCC,MAAlD;AACAH,UAAMI,OAAN,CAAchD,WAAW8C,UAAX,CAAuB,UAAvB,EAAoCC,MAAlD;AACD,GALD,CANiB,CAAZ,CAAP;AAaD;;AAED,SAASxB,SAAT,CAAmBmB,UAAnB,EAA+B;AAC7B,SAAOf,QAAQC,GAAR,CAAY,CACjBc,WAAWrC,MAAX,CAAkB4C,iBAAlB,CAAoCxD,YAAYL,SAAhD,CADiB,EAEjBsD,WAAWrC,MAAX,CAAkB4C,iBAAlB,CAAoCjD,WAAWZ,SAA/C,CAFiB,CAAZ,CAAP;AAID","file":"links.spec.js","sourcesContent":["import chai from 'chai';\nimport Micro, { LEVEL_ERROR } from '@microjs/microjs';\nimport { CONNECT_OPTIONS, CONNECT_OPTIONS_PG } from './constants';\nimport Plugin, {\n  Schema,\n  SchemaTypes,\n  PIN_CONNECTION,\n  PIN_LIST_CREATE,\n  PIN_LIST_FIND_ONE,\n  PIN_LIST_FIND_LIST\n} from '../index';\n\nconst tableName = 'module_links_db';\nconst should = chai.should();\nconst micro = Micro({\n  level  : LEVEL_ERROR,\n  plugins: [ Plugin(CONNECT_OPTIONS_PG) ]\n});\n\nconst imageSchema = new Schema('Image', {\n  src: { type: SchemaTypes.string, required: true },\n  alt: { type: SchemaTypes.string, null: true }\n}, { tableName: 'module_links_images' });\n\nconst userSchema = new Schema('User', {\n  login     : { type: SchemaTypes.string, required: true },\n  'icon1.id': {\n    type: SchemaTypes.number,\n    null: true,\n    link: {\n      one : { ...PIN_LIST_FIND_ONE, schema: imageSchema, options: { fields: 'full' } },\n      // Вызывается при загрузке множества User\n      list: { ...PIN_LIST_FIND_LIST, schema: imageSchema, options: { fields: 'full' } }\n    }\n  },\n  'icon2.id': {\n    type: SchemaTypes.number,\n    null: true,\n    link: {\n      one : { ...PIN_LIST_FIND_ONE, schema: imageSchema, options: { fields: 'full' } },\n      // Вызывается при загрузке множества User\n      list: { ...PIN_LIST_FIND_LIST, schema: imageSchema, options: { fields: 'full' } }\n    }\n  }\n}, { tableName: 'module_links_users' });\n\nbefore(() => micro\n  .run()\n  .then(() => micro.act(PIN_CONNECTION))\n  .then(createTable)\n  .then(() => micro\n    .act({ ...PIN_LIST_CREATE, schema: imageSchema, params: [\n      { src: 'http://example.ru/image1.png', alt: 'описание 1' },\n      { src: 'http://example.ru/image2.png', alt: 'описание 2' },\n      { src: 'http://example.ru/image3.png', alt: 'описание 3' },\n      { src: 'http://example.ru/image4.png', alt: 'описание 4' },\n    ] })\n    .then(([ img1, img2, img3, img4 ]) => micro.act({ ...PIN_LIST_CREATE, schema: userSchema, params: [\n      { login: 'user1', icon1: { id: img1.id }, icon2: { id: img2.id } },\n      { login: 'user2', icon1: { id: img3.id }, icon2: { id: img4.id } },\n    ] }))\n  )\n);\n\nafter(() => micro.act(PIN_CONNECTION)\n  .then(dropTable)\n  .then(() => micro.end()));\n\ndescribe('schema', function() {\n\n  it('#one link', () => Promise.all([\n      micro.act({ ...PIN_LIST_FIND_ONE,\n        schema  : userSchema,\n        options : { fields: 'full' },\n        criteria: { id: 1 }\n      }),\n      micro.act({ ...PIN_LIST_FIND_ONE,\n        schema  : userSchema,\n        options : { fields: 'full' },\n        criteria: { id: 2 }\n      })\n    ])\n    .then(validate)\n  );\n\n  it('#list link', () => micro\n    .act({ ...PIN_LIST_FIND_LIST, schema: userSchema, options: { fields: 'full' } })\n    .then(validate)\n  );\n\n  function validate([ user1, user2 ] = []) {\n    return Promise.all([\n      ...checkOne(user1, {\n        id   : 1,\n        login: 'user1',\n        icon1: { id: 1, src: 'http://example.ru/image1.png', alt: 'описание 1' },\n        icon2: { id: 2, src: 'http://example.ru/image2.png', alt: 'описание 2' },\n      }),\n      ...checkOne(user2, {\n        id   : 2,\n        login: 'user2',\n        icon1: { id: 3, src: 'http://example.ru/image3.png', alt: 'описание 3' },\n        icon2: { id: 4, src: 'http://example.ru/image4.png', alt: 'описание 4' },\n      })\n    ]);\n  }\n\n  function checkOne(user, equal) {\n    return [\n      user.should.be.a('object'),\n      user.should.have.property('id').be.a('number').equal(equal.id),\n      user.should.have.property('login').be.a('string').equal(equal.login),\n      ...checkIcon(user.icon1, equal.icon1),\n      ...checkIcon(user.icon2, equal.icon2)\n    ];\n  }\n\n  function checkIcon(icon, equal) {\n    return [\n      icon.should.be.a('object'),\n      icon.should.have.property('id').be.a('number').equal(equal.id),\n      icon.should.have.property('src').be.a('string').equal(equal.src),\n      icon.should.have.property('alt').be.a('string').equal(equal.alt),\n    ];\n  }\n});\n\n\nfunction createTable(connection) {\n  return Promise.all([\n    connection.schema.createTableIfNotExists(imageSchema.tableName, function (table) {\n      table.increments();\n      table.string(imageSchema.properties[ 'src' ].dbName);\n      table.string(imageSchema.properties[ 'alt' ].dbName);\n    }),\n    connection.schema.createTableIfNotExists(userSchema.tableName, function (table) {\n      table.increments();\n      table.string(userSchema.properties[ 'login' ].dbName);\n      table.integer(userSchema.properties[ 'icon1.id' ].dbName);\n      table.integer(userSchema.properties[ 'icon2.id' ].dbName);\n    })\n  ]);\n}\n\nfunction dropTable(connection) {\n  return Promise.all([\n    connection.schema.dropTableIfExists(imageSchema.tableName),\n    connection.schema.dropTableIfExists(userSchema.tableName),\n  ]);\n}"]}